/*\n * main_app.c\n * Application logic: CMSIS-RTOS2 tasks for sensor and display\n *\n * This file is intended to be used inside the CubeMX-generated project.\n * Place it in Src/ and include in build. Make sure to:\n *  - call InitDWT() once after HAL_Init()/SystemClock_Config()\n *  - call MX_I2C1_Init() and MX_GPIO_Init() (CubeMX generated)\n */\n\n#include "cmsis_os2.h"\n#include "dht22.h"\n#include "ssd1306_u8g2.h"\n#include "u8g2.h"\n#include <stdio.h>\n#include <math.h>\n\n/* Shared data */\ntypedef struct {\n  float temperature;\n  float humidity;\n  float dewpoint;\n} sensor_data_t;\n\nstatic sensor_data_t g_sensor_data = {0};\nstatic osMutexId_t data_mutex;\n\n/* DWT delay prototype - implement in main.c if not present */\nextern void InitDWT(void);\nextern void delay_us(uint32_t us);\n\n/* dew point (Magnus) */\nstatic float dewpoint_magnus(float T, float RH) {\n  const double a = 17.27;\n  const double b = 237.7;\n  double alpha = (a * T) / (b + T) + log(RH / 100.0);\n  double Td = (b * alpha) / (a - alpha);\n  return (float)Td;\n}\n\n/* Sensor task */\nvoid sensor_task(void *argument) {\n  (void)argument;\n  for (;;) {\n    float T = 0, RH = 0;\n    if (dht22_read(&T, &RH) == 0) {\n      float dew = dewpoint_magnus(T, RH);\n      if (osMutexAcquire(data_mutex, 100) == osOK) {\n        g_sensor_data.temperature = T;\n        g_sensor_data.humidity = RH;\n        g_sensor_data.dewpoint = dew;\n        osMutexRelease(data_mutex);\n      }\n    }\n    osDelay(3000); /* DHT22 minimum ~2s; use 3s */\n  }\n}\n\n/* Display task */\nvoid display_task(void *argument) {\n  (void)argument;\n  ssd1306_u8g2_init();\n  u8g2_t *u8g2 = ssd1306_u8g2_get_u8g2();\n  char buf[64];\n\n  for (;;) {\n    sensor_data_t snap;\n    if (osMutexAcquire(data_mutex, 100) == osOK) {\n      snap = g_sensor_data;\n      osMutexRelease(data_mutex);\n    }\n    /* Draw using u8g2 */\n    u8g2_ClearBuffer(u8g2);\n    snprintf(buf, sizeof(buf), "T: %.1f C", snap.temperature);\n    u8g2_SetFont(u8g2, u8g2_font_ncenB08_tr);\n    u8g2_DrawStr(u8g2, 0, 12, buf);\n    snprintf(buf, sizeof(buf), "RH: %.1f %%", snap.humidity);\n    u8g2_DrawStr(u8g2, 0, 28, buf);\n    snprintf(buf, sizeof(buf), "Dew: %.1f C", snap.dewpoint);\n    u8g2_DrawStr(u8g2, 0, 44, buf);\n    u8g2_SendBuffer(u8g2);\n\n    osDelay(500);\n  }\n}\n\n/* Application init (call this once after HAL init and before osKernelStart) */\nvoid app_init(void) {\n  /* Init DWT for microsecond delays */\n  InitDWT();\n\n  /* Create mutex */\n  const osMutexAttr_t mutex_attr = { .name = "dataMutex" };\n  data_mutex = osMutexNew(&mutex_attr);\n\n  /* Create tasks */\n  const osThreadAttr_t sensor_attr = { .name = "Sensor", .priority = osPriorityAboveNormal, .stack_size = 1024 };\n  const osThreadAttr_t display_attr = { .name = "Display", .priority = osPriorityNormal, .stack_size = 1024 };\n\n  osThreadNew(sensor_task, NULL, &sensor_attr);\n  osThreadNew(display_task, NULL, &display_attr);\n}