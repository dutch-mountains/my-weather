/*\n * ssd1306_u8g2.c\n * u8g2 HAL-I2C transport implementation for STM32 HAL (I2C1, address 0x3C).\n *\n * This file implements u8g2's byte callback and rotation init.\n * You must add the u8g2 sources (u8g2.c, fonts, etc.) to the project.\n */\n\n#include "ssd1306_u8g2.h"\n#include "stm32f4xx_hal.h"\n#include "main.h"\n#include <string.h>\n\n/* Default I2C handle created by CubeMX */\nextern I2C_HandleTypeDef hi2c1;\n\n/* u8g2 object */\nstatic u8g2_t u8g2;\n\n/* I2C address */\n#define SSD1306_ADDR (0x3C << 1)\n\n/* u8g2 byte callback for I2C */\nuint8_t u8g2_byte_stm32_hal_i2c(u8g2_t *u8g2, uint8_t msg, uint8_t arg_int, void *arg_ptr) {\n  switch (msg) {\n    case U8G2_MSG_BYTE_INIT:\n      /* nothing to init here, HAL I2C configured by CubeMX */\n      return 1;\n    case U8G2_MSG_BYTE_START_TRANSFER:\n      return 1;\n    case U8G2_MSG_BYTE_SEND:\n      {\n        uint8_t *buf = (uint8_t *)arg_ptr;\n        if (arg_int == 0) return 1;\n        /* Prepend control byte 0x40 for data or 0x00 for commands is handled in u8g2 */\n        HAL_StatusTypeDef st = HAL_I2C_Master_Transmit(&hi2c1, SSD1306_ADDR, buf, arg_int, 1000);\n        return (st == HAL_OK) ? 1 : 0;\n      }\n    case U8G2_MSG_BYTE_END_TRANSFER:\n      return 1;\n  }\n  return 0;\n}\n\nvoid ssd1306_u8g2_init(void) {\n  /* Initialize u8g2 for SSD1306 128x64 I2C, using U8G2_R0 rotation.\n     Requires u8g2 setup call from u8g2 library; example: u8g2_Setup_ssd1306_i2c_128x64_noname_f()\n     NOTE: adjust the setup function if you use a different controller. */\n  u8g2_Setup_ssd1306_i2c_128x64_noname_f(&u8g2, U8G2_R0, u8g2_byte_stm32_hal_i2c, u8g2_gpio_and_delay_stub);\n  u8g2_InitDisplay(&u8g2);\n  u8g2_SetPowerSave(&u8g2, 0);\n}\n\nu8g2_t *ssd1306_u8g2_get_u8g2(void) {\n  return &u8g2;\n}\n